<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>学習内容イラスト（2〜169行目）</title>
  <style>
    body { font-family: "Hiragino Sans", "Yu Gothic", sans-serif; background: #e8eae8; padding: 20px; margin: 0; }
    h1 { font-size: 1.35rem; margin: 0 0 8px 0; color: #1a1a1a; }
    .toolbar { background: #fff; padding: 14px 18px; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,.08); margin-bottom: 20px; }
    .toolbar p:first-of-type { margin: 0 0 12px 0; color: #444; font-size: 0.9rem; line-height: 1.5; }
    .toolbar .buttons { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
    .card-count { font-size: 0.85rem; color: #666; margin-left: 8px; }
    #cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
    .card { position: relative; background: #fff; padding: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.08); break-inside: avoid; overflow: hidden; box-sizing: border-box; }
    .card-row-badge { position: absolute; top: 10px; left: 10px; z-index: 10; background: linear-gradient(135deg, #ffb5c2 0%, #ff9aab 100%); color: #fff; font-size: 0.8rem; font-weight: 600; padding: 5px 10px; border-radius: 20px; min-width: 32px; text-align: center; box-shadow: 0 2px 8px rgba(255,120,140,.35); letter-spacing: 0.02em; }
    .card-select-wrap { position: absolute; top: 8px; right: 8px; z-index: 10; }
    .card-select-wrap label { display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.8rem; color: #333; user-select: none; background: rgba(255,255,255,.95); padding: 4px 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,.2); }
    .card-select-wrap input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
    .card figcaption { margin-top: 8px; font-size: 0.8rem; color: #666; }
    .img-wrap { position: relative; display: block; line-height: 0; max-width: 100%; overflow: hidden; }
    .img-wrap img { display: block; max-width: 100%; width: 100%; height: auto; object-fit: contain; vertical-align: top; }
    .img-wrap img.load-error { min-width: 200px; min-height: 150px; background: #e8e8e8; object-fit: none; }
    .img-placeholder { display: flex; align-items: center; justify-content: center; min-height: 140px; background: #e8e8e8; color: #888; font-size: 0.8rem; text-align: center; padding: 12px; box-sizing: border-box; }
    .label-overlay {
      position: absolute;
      left: 18px;
      top: 20px;
      max-width: 100%;
      color: #000;
      text-shadow: 0 -2px 0 #fff, 0 2px 0 #fff, -2px 0 0 #fff, 2px 0 0 #fff, -2px -2px 0 #fff, 2px -2px 0 #fff, -2px 2px 0 #fff, 2px 2px 0 #fff, -1px -2px 0 #fff, 1px -2px 0 #fff, -1px 2px 0 #fff, 1px 2px 0 #fff, -2px -1px 0 #fff, 2px -1px 0 #fff, -2px 1px 0 #fff, 2px 1px 0 #fff;
      font-weight: bold;
      cursor: move;
      padding: 0;
      box-sizing: border-box;
      font-family: "Hiragino Maru Gothic ProN", "Hiragino Maru Gothic Pro", "UD Digi Kyokasho", "BIZ UDGothic", "M+ 1p", "Hiragino Sans", "Yu Gothic", sans-serif;
    }
    .label-overlay.dragging {
      cursor: grabbing;
    }
    .label-overlay.editing {
      cursor: text;
    }
    .label-overlay .label-text {
      display: block;
      min-height: 1.2em;
      outline: none;
      user-select: text;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
      line-height: 1.4;
    }
    .size-control { margin-top: 4px; font-size: 0.8rem; }
    .size-control label { margin-right: 6px; }
    .size-control input[type="range"] { width: 80px; vertical-align: middle; }
    .btn-export { margin-top: 6px; padding: 4px 10px; font-size: 0.85rem; cursor: pointer; }
    .btn-export-all { margin-bottom: 16px; padding: 10px 20px; font-size: 1rem; cursor: pointer; background: #2196F3; color: #fff; border: none; border-radius: 6px; }
    .btn-export-all:hover { background: #1976D2; }
    .btn-export-all:disabled { background: #9e9e9e; cursor: not-allowed; }
    .btn-export-selected { margin-bottom: 16px; margin-left: 8px; padding: 10px 20px; font-size: 1rem; cursor: pointer; background: #4CAF50; color: #fff; border: none; border-radius: 6px; }
    .btn-export-selected:hover { background: #388E3C; }
    .btn-export-selected:disabled { background: #9e9e9e; cursor: not-allowed; }
    .export-status { margin-left: 4px; color: #555; font-size: 0.9rem; }
    @media (max-width: 640px) {
      #cards { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <h1>学習内容イラスト（2行目〜169行目）</h1>
    <p>テーマ文字を直接ドラッグで移動、クリックで編集できます。改行（Enter）にも対応。スライダーで大きさを変更できます。</p>
    <div class="buttons">
      <button type="button" id="btn-export-all" class="btn-export-all">全て一括でPNG書き出し</button>
      <button type="button" id="btn-export-selected" class="btn-export-selected">選択したものを一括でPNG書き出し</button>
      <span id="export-all-status" class="export-status"></span>
      <span id="card-count" class="card-count"></span>
    </div>
  </div>

  <div id="cards"></div>

  <script>
(function() {
  const DATA = [
    { row: 2, label: "対象を決める", file: "img/row2_対象を決める.png", char: "リク" },
    { row: 3, label: "学習の目的の理解", file: "img/row8_学習の目的の理解.png", char: "アオイ" },
    { row: 4, label: "目的（5W1H）", file: "img/row6_目的（5W1H）.png", char: "サクラ" },
    { row: 5, label: "問題の整理と分析", file: "img/row7_問題の整理と分析.png", char: "ハルト" },
    { row: 6, label: "解決策の立案・仮説", file: "img/row5_解決策の立案・仮説.png", char: "リク" },
    { row: 7, label: "シンキングサイクルの理解", file: "img/row4_シンキングサイクル.png", char: "アオイ" },
    { row: 8, label: "計画を立てる", file: "img/row8_計画を立てる.png", char: "サクラ" },
    { row: 9, label: "条件制御", file: "img/row12_条件制御.png", char: "ハルト" },
    { row: 10, label: "比較する（具体物と具体物）", file: "img/row10_比較する（具体物と具体物）.png", char: "リク" },
    { row: 11, label: "比較する（文章と文章）", file: "img/row13_比較する（文章と文章）.png", char: "アオイ" },
    { row: 12, label: "情報の集め方", file: "img/row18_情報の集め方・見方.png", char: "サクラ" },
    { row: 13, label: "計画の具体化", file: "img/row19_計画の具体化.png", char: "ハルト" },
    { row: 14, label: "五感", file: "img/row9_五感.png", char: "リク" },
    { row: 15, label: "言葉を集める", file: "img/row11_言葉を集める.png", char: "アオイ" },
    { row: 16, label: "インタビュー方法", file: "img/row14_インタビュー方法.png", char: "サクラ" },
    { row: 17, label: "メモの取り方", file: "img/row15_メモの取り方.png", char: "ハルト" },
    { row: 18, label: "検索", file: "img/row16_検索.png", char: "リク" },
    { row: 19, label: "アンケート作成", file: "img/row20_アンケート作成.png", char: "アオイ" },
    { row: 20, label: "フォームズ（質問）", file: "img/row23_フォームズ（質問）.png", char: "サクラ" },
    { row: 21, label: "アップとルーズ", file: "img/row21_アップとルーズ.png", char: "ハルト" },
    { row: 22, label: "教科書", file: "img/row22_教科書.png", char: "リク" },
    { row: 23, label: "インターネット", file: "img/row23_インターネット.png", char: "アオイ" },
    { row: 24, label: "図書資料", file: "img/row24_図書資料.png", char: "サクラ" },
    { row: 25, label: "新聞", file: "img/row25_新聞.png", char: "ハルト" },
    { row: 26, label: "観察・実験・調査", file: "img/row26_観察・実験・調査.png", char: "リク" },
    { row: 27, label: "出典", file: "img/row27_出典.png", char: "アオイ" },
    { row: 28, label: "惑わされない視点", file: "img/row17_惑わされない視点.png", char: "サクラ" },
    { row: 29, label: "記録", file: "img/row29_記録.png", char: "ハルト" },
    { row: 30, label: "ピクトグラム", file: "img/row22_ピクトグラム.png", char: "リク" },
    { row: 31, label: "同異点整理", file: "img/row31_同異点整理.png", char: "アオイ" },
    { row: 32, label: "ベン図", file: "img/row31_ベン図.png", char: "サクラ" },
    { row: 33, label: "分類", file: "img/row25_分類する.png", char: "ハルト" },
    { row: 34, label: "関連付け", file: "img/row41_関係づける.png", char: "リク" },
    { row: 35, label: "傾向分析", file: "img/row35_傾向分析.png", char: "アオイ" },
    { row: 36, label: "順序付ける", file: "img/row32_順序付ける.png", char: "サクラ" },
    { row: 37, label: "構造化", file: "img/row35_構造化.png", char: "ハルト" },
    { row: 38, label: "抽象化", file: "img/row38_抽象化.png", char: "リク" },
    { row: 39, label: "具体化", file: "img/row39_具体化.png", char: "アオイ" },
    { row: 40, label: "理由づけ", file: "img/row37_理由づけ.png", char: "サクラ" },
    { row: 41, label: "五感（分析）", file: "img/五感（分析）.png", char: "ハルト" },
    { row: 42, label: "置き換え（アナロジー）", file: "img/row43_置き換え（アナロジー）.png", char: "サクラ" },
    { row: 43, label: "多視点（立場）", file: "img/多視点（立場）.png", char: "リク" },
    { row: 44, label: "多視点（時間）", file: "img/多視点（時間）.png", char: "サクラ" },
    { row: 45, label: "教科の見方・考え方", file: "img/教科の見方・考え方.png", char: "ハルト" },
    { row: 46, label: "比較する", file: "img/row24_比較する.png", char: "リク" },
    { row: 47, label: "分解する", file: "img/分解.png", char: "アオイ" },
    { row: 48, label: "統合する", file: "img/統合.png", char: "サクラ" },
    { row: 49, label: "多面的・多角的", file: "img/row39_多面的・多角的.png", char: "ハルト" },
    { row: 50, label: "計画の実行", file: "img/row34_計画の実行.png", char: "リク" },
    { row: 51, label: "表や図への整理する", file: "img/row26_表や図への整理.png", char: "アオイ" },
    { row: 52, label: "言葉を分類する", file: "img/row27_言葉を分類する.png", char: "サクラ" },
    { row: 53, label: "視点", file: "img/row28_視点ごと.png", char: "ハルト" },
    { row: 54, label: "広げる", file: "img/row40_広げる.png", char: "リク" },
    { row: 55, label: "事柄の順序", file: "img/row29_事柄の順序.png", char: "アオイ" },
    { row: 56, label: "主張・考え・事実", file: "img/row36_主張・考え・事実.png", char: "サクラ" },
    { row: 57, label: "KJ法", file: "img/row30_KJ法.png", char: "ハルト" },
    { row: 58, label: "グラフへの変換", file: "img/row33_グラフへの変換.png", char: "リク" },
    { row: 59, label: "表計算ソフトの関数（Sum、Average）", file: "img/row38_表計算ソフトの関数（Sum、Average）.png", char: "アオイ" },
    { row: 60, label: "主題設定", file: "img/主題設定.png", char: "サクラ" },
    { row: 61, label: "論理的思考", file: "img/論理的思考.png", char: "ハルト" },
    { row: 62, label: "要約・統合", file: "img/要約・統合.png", char: "リク" },
    { row: 63, label: "伝達方法の選択", file: "img/伝達方法の選択.png", char: "アオイ" },
    { row: 64, label: "表現工夫・創造性", file: "img/表現工夫・創造性.png", char: "サクラ" },
    { row: 65, label: "プレゼンテーション", file: "img/row43_プレゼンテーション.png", char: "ハルト" },
    { row: 66, label: "実演", file: "img/実演.png", char: "リク" },
    { row: 67, label: "論文", file: "img/論文.png", char: "アオイ" },
    { row: 68, label: "レポート", file: "img/row46_レポート.png", char: "サクラ" },
    { row: 69, label: "作品", file: "img/作品.png", char: "ハルト" },
    { row: 70, label: "動画", file: "img/動画.png", char: "リク" },
    { row: 71, label: "ポスター", file: "img/ポスター.png", char: "アオイ" },
    { row: 72, label: "見出し・図表・文字サイズ", file: "img/row49_見出し・図表・文字サイズ.png", char: "サクラ" },
    { row: 73, label: "箇条書き", file: "img/row50_箇条書き.png", char: "ハルト" },
    { row: 74, label: "レイアウト", file: "img/row51_レイアウト.png", char: "リク" },
    { row: 75, label: "問題解決の振り返り", file: "img/row42_問題解決の振り返り.png", char: "アオイ" },
    { row: 76, label: "（要設定）", file: "", char: "サクラ" },
    { row: 77, label: "相互評価", file: "img/row44_相互評価.png", char: "ハルト" },
    { row: 78, label: "自己評価", file: "img/row45_自己評価.png", char: "リク" },
    { row: 79, label: "計画結果の評価", file: "img/row47_計画結果の評価.png", char: "アオイ" },
    { row: 80, label: "探究", file: "img/row48_探究.png", char: "サクラ" },
    { row: 81, label: "（要設定）", file: "", char: "ハルト" },
    { row: 82, label: "（要設定）", file: "", char: "リク" },
    { row: 83, label: "（要設定）", file: "", char: "アオイ" },
    { row: 84, label: "（要設定）", file: "", char: "サクラ" },
    { row: 85, label: "電源ON", file: "img/row52_電源ON.png", char: "ハルト" },
    { row: 86, label: "パスワード入力", file: "img/row53_パスワード入力.png", char: "リク" },
    { row: 87, label: "ログイン", file: "img/row54_ログイン.png", char: "アオイ" },
    { row: 88, label: "写真撮影", file: "img/row55_写真撮影.png", char: "サクラ" },
    { row: 89, label: "課題提出", file: "img/row56_課題提出.png", char: "ハルト" },
    { row: 90, label: "画面タッチ", file: "img/row57_画面タッチ.png", char: "リク" },
    { row: 91, label: "タッチペン", file: "img/row58_タッチペン.png", char: "アオイ" },
    { row: 92, label: "静止画閲覧", file: "img/row59_静止画閲覧.png", char: "サクラ" },
    { row: 93, label: "動画撮影", file: "img/row60_動画撮影.png", char: "ハルト" },
    { row: 94, label: "プログラミング", file: "img/row61_プログラミング.png", char: "リク" },
    { row: 95, label: "ドラッグ＆ドロップ", file: "img/row62_ドラッグ＆ドロップ.png", char: "アオイ" },
    { row: 96, label: "キーボード入力", file: "img/row63_キーボード入力.png", char: "サクラ" },
    { row: 97, label: "ファイル", file: "img/row64_ファイル.png", char: "ハルト" },
    { row: 98, label: "画像の削除", file: "img/row65_画像の削除.png", char: "リク" },
    { row: 99, label: "スライドの基本操作", file: "img/row66_スライドの基本操作.png", char: "アオイ" },
    { row: 100, label: "写真挿入", file: "img/row67_写真挿入.png", char: "サクラ" },
    { row: 101, label: "ホームポジション", file: "img/row68_ホームポジション.png", char: "ハルト" },
    { row: 102, label: "動画視聴", file: "img/row69_動画視聴.png", char: "リク" },
    { row: 103, label: "リンク共有", file: "img/row70_リンク共有.png", char: "アオイ" },
    { row: 104, label: "スクリーンショット", file: "img/row71_スクリーンショット.png", char: "サクラ" },
    { row: 105, label: "コピー＆ペースト", file: "img/row72_コピー＆ペースト.png", char: "ハルト" },
    { row: 106, label: "プレゼンテーションモード", file: "img/row73_プレゼンテーションモード.png", char: "リク" },
    { row: 107, label: "テキストボックス", file: "img/row74_テキストボックス.png", char: "アオイ" },
    { row: 108, label: "2次元コード読み取り", file: "img/row75_2次元コード読み取り.png", char: "サクラ" },
    { row: 109, label: "OneDriveへのアクセス", file: "img/row76_OneDriveへのアクセス.png", char: "ハルト" },
    { row: 110, label: "タイピング", file: "img/row77_タイピング.png", char: "リク" },
    { row: 111, label: "Excel入力", file: "img/row78_Excel入力.png", char: "アオイ" },
    { row: 112, label: "インターネット検索", file: "img/row79_インターネット検索.png", char: "サクラ" },
    { row: 113, label: "インターネット閲覧", file: "img/row80_インターネット閲覧.png", char: "ハルト" },
    { row: 114, label: "チャット", file: "img/row81_チャット.png", char: "リク" },
    { row: 115, label: "チャット（コメント）", file: "img/row82_チャット（コメント）.png", char: "アオイ" },
    { row: 116, label: "スライド作成", file: "img/row83_スライド作成.png", char: "サクラ" },
    { row: 117, label: "スライドの共有", file: "img/row84_スライドの共有.png", char: "ハルト" },
    { row: 118, label: "フォント", file: "img/row85_フォント.png", char: "リク" },
    { row: 119, label: "グリッド線", file: "img/row86_グリッド線.png", char: "アオイ" },
    { row: 120, label: "文字数", file: "img/row87_文字数.png", char: "サクラ" },
    { row: 121, label: "レポート（アウトライン機能）", file: "img/row88_レポート（アウトライン機能）.png", char: "ハルト" },
    { row: 122, label: "カレンダー", file: "img/row89_カレンダー.png", char: "リク" },
    { row: 123, label: "ToDo", file: "img/row90_ToDo.png", char: "アオイ" },
    { row: 124, label: "メモ", file: "img/row91_メモ.png", char: "サクラ" },
    { row: 125, label: "動画のトリミング", file: "img/row92_動画のトリミング.png", char: "ハルト" },
    { row: 126, label: "動画のタイトル挿入", file: "img/row93_動画のタイトル挿入.png", char: "リク" },
    { row: 127, label: "個人情報保護", file: "img/row94_個人情報保護.png", char: "アオイ" },
    { row: 128, label: "個人情報の取り扱い", file: "img/row95_個人情報の取り扱い.png", char: "サクラ" },
    { row: 129, label: "肖像権", file: "img/row96_肖像権.png", char: "ハルト" },
    { row: 130, label: "著作権", file: "img/row97_著作権.png", char: "リク" },
    { row: 131, label: "学習目的での利用", file: "img/row98_学習目的での利用.png", char: "アオイ" },
    { row: 132, label: "パソコン利用の目的とルール", file: "img/row99_パソコン利用の目的とルール.png", char: "サクラ" },
    { row: 133, label: "利用時間", file: "img/row100_利用時間.png", char: "ハルト" },
    { row: 134, label: "家庭での約束", file: "img/row101_家庭での約束.png", char: "リク" },
    { row: 135, label: "共同編集の留意点", file: "img/row102_共同編集の留意点.png", char: "アオイ" },
    { row: 136, label: "出典の明記", file: "img/row103_出典の明記.png", char: "サクラ" },
    { row: 137, label: "誹謗中傷", file: "img/row104_誹謗中傷.png", char: "ハルト" },
    { row: 138, label: "引用", file: "img/row105_引用.png", char: "" },
    { row: 139, label: "炎上", file: "img/row106_炎上.png", char: "" },
    { row: 140, label: "他者の作品の尊重", file: "img/row107_他者の作品の尊重.png", char: "" },
    { row: 141, label: "友だちの発表の尊重", file: "img/友だちの発表の尊重.png", char: "" },
    { row: 142, label: "撮影時の注意", file: "img/撮影時の注意.png", char: "" },
    { row: 143, label: "相手への伝え方", file: "img/row110_相手への伝え方.png", char: "" },
    { row: 144, label: "送り手の意図", file: "img/row111_送り手の意図.png", char: "" },
    { row: 145, label: "受け手の立場", file: "img/row112_受け手の立場.png", char: "" },
    { row: 146, label: "詐欺グラフ", file: "img/row113_詐欺グラフ.png", char: "" },
    { row: 147, label: "切り取られた情報", file: "img/row114_切り取られた情報.png", char: "" },
    { row: 148, label: "姿勢", file: "img/row115_姿勢.png", char: "" },
    { row: 149, label: "視力", file: "img/row116_視力.png", char: "" },
    { row: 150, label: "ネット依存", file: "img/row117_ネット依存.png", char: "" },
    { row: 151, label: "使い過ぎ", file: "img/row118_使い過ぎ.png", char: "" },
    { row: 152, label: "端末の管理", file: "img/row119_端末の管理.png", char: "" },
    { row: 153, label: "IDパスワード", file: "img/row120_IDパスワード.png", char: "" },
    { row: 154, label: "フィッシング", file: "img/row121_フィッシング.png", char: "" },
    { row: 155, label: "架空請求", file: "img/row122_架空請求.png", char: "" },
    { row: 156, label: "ワンクリック詐欺", file: "img/row123_ワンクリック詐欺.png", char: "" },
    { row: 157, label: "フェイクニュース", file: "img/row124_フェイクニュース.png", char: "" },
    { row: 158, label: "SNS", file: "img/row125_SNS.png", char: "" },
    { row: 159, label: "情報の信憑性", file: "img/row126_情報の信憑性.png", char: "" },
    { row: 160, label: "共同編集の仕組み", file: "img/row127_共同編集の仕組み.png", char: "" },
    { row: 161, label: "AIの活用", file: "img/row128_AIの活用.png", char: "" },
    { row: 162, label: "AIの特性（画像生成）", file: "img/row129_AIの特性（画像生成）.png", char: "" },
    { row: 163, label: "画像認識AI", file: "img/row130_画像認識AI.png", char: "" },
    { row: 164, label: "生成AIの活用", file: "img/row131_生成AIの活用.png", char: "" },
    { row: 165, label: "カラーユニバーサルデザイン", file: "img/row133_カラーユニバーサルデザイン.png", char: "" } ,
    { row: 166, label: "データの見方（読み取り）", file: "img/row134_データの見方（読み取り）.png", char: "" },
    { row: 167, label: "グラフのつくり方", file: "img/row135_グラフのつくり方.png", char: "" },
    { row: 168, label: "メディアの特性", file: "img/メディアの特性.png", char: "" },
    { row: 169, label: "責任", file: "img/責任.png", char: "" },
  ];

  const cardsEl = document.getElementById("cards");
  const DEFAULT_FONT_SIZE = 32;
  const MIN_FONT = 12;
  const MAX_FONT = 72;
  const DEFAULT_MAX_WIDTH = 70;
  const REFERENCE_IMAGE_WIDTH = 400;
  const MIN_MAX_WIDTH = 30;
  const MAX_MAX_WIDTH = 100;

  function makeCard(item) {
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.filename = item.file;
    card.dataset.row = String(item.row);

    const rowBadge = document.createElement("div");
    rowBadge.className = "card-row-badge";
    rowBadge.textContent = item.row;
    rowBadge.title = item.row + " 行目";
    card.appendChild(rowBadge);

    const selectWrap = document.createElement("div");
    selectWrap.className = "card-select-wrap";
    const selectLabel = document.createElement("label");
    const selectCb = document.createElement("input");
    selectCb.type = "checkbox";
    selectCb.className = "card-select";
    selectLabel.appendChild(selectCb);
    selectLabel.appendChild(document.createTextNode("OK"));
    selectWrap.appendChild(selectLabel);
    card.appendChild(selectWrap);

    const wrap = document.createElement("figure");
    wrap.className = "img-wrap";

    const img = document.createElement("img");
    img.alt = item.label;
    img.loading = "lazy";
    if (item.file) {
      img.src = item.file;
      img.addEventListener("load", function() {
        requestAnimationFrame(function() { updateOverlayScale(card); });
      });
      img.addEventListener("error", function() {
        img.classList.add("load-error");
        const placeholder = document.createElement("div");
        placeholder.className = "img-placeholder";
        placeholder.textContent = "画像がありません\n（" + item.file + "）";
        wrap.insertBefore(placeholder, img);
        img.style.display = "none";
        overlay.style.display = "none";
      });
    } else {
      img.style.display = "none";
      const placeholder = document.createElement("div");
      placeholder.className = "img-placeholder";
      placeholder.textContent = "画像がありません\n（未設定）";
      wrap.appendChild(placeholder);
    }

    const overlay = document.createElement("div");
    overlay.className = "label-overlay";
    overlay.style.fontSize = DEFAULT_FONT_SIZE + "px";
    overlay.style.maxWidth = DEFAULT_MAX_WIDTH + "%";
    const textEl = document.createElement("span");
    textEl.className = "label-text";
    textEl.contentEditable = "true";
    textEl.textContent = item.label;
    overlay.appendChild(textEl);

    let drag = null;
    let dragStartPos = null;

    // テキスト編集モードの切り替え
    textEl.addEventListener("focus", function() {
      overlay.classList.add("editing");
      overlay.classList.remove("dragging");
    });
    textEl.addEventListener("blur", function() {
      overlay.classList.remove("editing");
    });

    // テキストエリアでのマウスダウン：少し動かしたらドラッグ、動かなければ編集
    textEl.addEventListener("mousedown", function(e) {
      const selection = window.getSelection();
      // テキストが選択されている場合は編集モード（ドラッグしない）
      if (selection.toString().length > 0) {
        return;
      }
      
      dragStartPos = { x: e.clientX, y: e.clientY, time: Date.now() };
      const startLeft = parseInt(overlay.style.left, 10) || 18;
      const startTop = parseInt(overlay.style.top, 10) || 20;
      
      const onMove = function(moveEvent) {
        const dx = Math.abs(moveEvent.clientX - dragStartPos.x);
        const dy = Math.abs(moveEvent.clientY - dragStartPos.y);
        // 5px以上動いたらドラッグモード
        if (dx > 5 || dy > 5) {
          e.preventDefault();
          drag = {
            startX: dragStartPos.x,
            startY: dragStartPos.y,
            left: startLeft,
            top: startTop
          };
          overlay.classList.add("dragging");
          overlay.classList.remove("editing");
          textEl.blur();
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        }
      };
      
      const onUp = function() {
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
        if (!drag) {
          // 動いていなければ編集モード
          setTimeout(function() {
            textEl.focus();
            const range = document.createRange();
            range.selectNodeContents(textEl);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
          }, 10);
        }
        dragStartPos = null;
      };
      
      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
    });

    // ドラッグ中
    document.addEventListener("mousemove", function(e) {
      if (!drag) return;
      const dx = e.clientX - drag.startX, dy = e.clientY - drag.startY;
      const imgRect = wrap.getBoundingClientRect();
      const maxLeft = imgRect.width - overlay.offsetWidth;
      const maxTop = imgRect.height - overlay.offsetHeight;
      overlay.style.left = Math.max(0, Math.min(maxLeft, drag.left + dx)) + "px";
      overlay.style.top = Math.max(0, Math.min(maxTop, drag.top + dy)) + "px";
    });

    // ドラッグ終了
    document.addEventListener("mouseup", function() {
      if (drag) {
        drag = null;
        overlay.classList.remove("dragging");
      }
    });

    const sizeControl = document.createElement("div");
    sizeControl.className = "size-control";
    sizeControl.innerHTML = '<label>文字サイズ</label><input type="range" min="' + MIN_FONT + '" max="' + MAX_FONT + '" value="' + DEFAULT_FONT_SIZE + '">';
    const range = sizeControl.querySelector('input[type="range"]');
    range.addEventListener("input", function() {
      updateOverlayScale(card);
    });

    const widthControl = document.createElement("div");
    widthControl.className = "size-control";
    widthControl.innerHTML = '<label>折り返し幅</label><input type="range" min="' + MIN_MAX_WIDTH + '" max="' + MAX_MAX_WIDTH + '" value="' + DEFAULT_MAX_WIDTH + '">';
    const widthRange = widthControl.querySelector('input[type="range"]');
    widthRange.addEventListener("input", function() {
      updateOverlayScale(card);
    });

    const cap = document.createElement("figcaption");
    cap.textContent = item.row + " 行目（" + item.char + "）";

    const btnExport = document.createElement("button");
    btnExport.className = "btn-export";
    btnExport.textContent = "PNGで書き出し";
    btnExport.addEventListener("click", function() {
      exportCard(card);
    });

    wrap.appendChild(img);
    wrap.appendChild(overlay);
    card.appendChild(wrap);
    card.appendChild(sizeControl);
    card.appendChild(widthControl);
    card.appendChild(cap);
    card.appendChild(btnExport);
    cardsEl.appendChild(card);

    requestAnimationFrame(function() {
      updateOverlayScale(card);
      if (typeof ResizeObserver !== "undefined") {
        var ro = new ResizeObserver(function() { updateOverlayScale(card); });
        ro.observe(wrap);
      }
    });
    if (!item.file) requestAnimationFrame(function() { updateOverlayScale(card); });
  }

  function escapeHtml(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  function updateOverlayScale(cardEl) {
    const wrap = cardEl.querySelector(".img-wrap");
    const overlay = cardEl.querySelector(".label-overlay");
    if (!wrap || !overlay) return;
    const w = wrap.offsetWidth;
    if (w < 1) return;
    const ratio = w / REFERENCE_IMAGE_WIDTH;
    var sizeControls = cardEl.querySelectorAll(".size-control");
    var fontRange = sizeControls[0] ? sizeControls[0].querySelector('input[type="range"]') : null;
    var widthRange = sizeControls[1] ? sizeControls[1].querySelector('input[type="range"]') : null;
    var logicalFontSize = fontRange ? parseFloat(fontRange.value) : DEFAULT_FONT_SIZE;
    var logicalPercent = widthRange ? parseFloat(widthRange.value) : DEFAULT_MAX_WIDTH;
    var leftPx = 18 * ratio;
    var topPx = 20 * ratio;
    overlay.style.transform = "none";
    overlay.style.left = leftPx + "px";
    overlay.style.top = topPx + "px";
    overlay.style.fontSize = (logicalFontSize * ratio) + "px";
    var maxWidthPx = (w - leftPx) * (logicalPercent / 100);
    overlay.style.maxWidth = maxWidthPx + "px";
  }

  function exportCard(cardEl) {
    const imgEl = cardEl.querySelector("img");
    const overlay = cardEl.querySelector(".label-overlay");
    if (!imgEl || !imgEl.complete || imgEl.naturalWidth === 0) {
      alert("画像の読み込みが完了してから書き出してください。");
      return;
    }
    const textEl = overlay.querySelector(".label-text");
    const text = (textEl && textEl.textContent) || "タイトル";
    const fontSize = parseInt(overlay.style.fontSize, 10) || DEFAULT_FONT_SIZE;
    const left = parseInt(overlay.style.left, 10) || 18;
    const top = parseInt(overlay.style.top, 10) || 20;
    const imgRect = cardEl.querySelector(".img-wrap").getBoundingClientRect();
    const maxWidthStr = (overlay.style.maxWidth || "").trim();
    let textMaxWidth;
    if (maxWidthStr.indexOf("px") >= 0) {
      textMaxWidth = parseFloat(maxWidthStr) || imgRect.width;
    } else {
      const pct = parseFloat(maxWidthStr) || 100;
      textMaxWidth = imgRect.width * pct / 100;
    }

    const scale = imgEl.naturalWidth / imgEl.width;
    const c = document.createElement("canvas");
    c.width = imgEl.naturalWidth;
    c.height = imgEl.naturalHeight;
    const ctx = c.getContext("2d");
    ctx.drawImage(imgEl, 0, 0);
    
    // UDフォントで描画（縁取りは白を複数オフセットで描画してから黒で上書き＝途切れない）
    const scaledFontSize = Math.round(fontSize * scale);
    const outlineWidth = Math.max(2, Math.round(scaledFontSize / 10));
    ctx.font = "bold " + scaledFontSize + "px \"Hiragino Maru Gothic ProN\", \"Hiragino Maru Gothic Pro\", \"UD Digi Kyokasho\", \"BIZ UDGothic\", \"M+ 1p\", \"Hiragino Sans\", \"Yu Gothic\", sans-serif";
    ctx.textBaseline = "top";
    ctx.textAlign = "left";

    function drawLineWithOutline(lineText, x, y) {
      ctx.fillStyle = "#fff";
      for (var dy = -outlineWidth; dy <= outlineWidth; dy++) {
        for (var dx = -outlineWidth; dx <= outlineWidth; dx++) {
          if (dx === 0 && dy === 0) continue;
          ctx.fillText(lineText, x + dx, y + dy);
        }
      }
      ctx.fillStyle = "#000";
      ctx.fillText(lineText, x, y);
    }

    // 改行対応：テキストを行ごとに分割して描画
    const lines = text.split("\n");
    const lineHeight = scaledFontSize * 1.4;
    const scaledLeft = left * scale;
    const scaledTop = top * scale;
    const scaledMaxWidth = textMaxWidth * scale;
    let currentY = scaledTop;

    lines.forEach(function(line) {
      if (line.trim() === "") {
        currentY += lineHeight; // 空行は高さだけ進める
        return;
      }

      // 長い行は自動改行（文字単位で分割）
      let currentLine = "";
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const testLine = currentLine + char;
        const metrics = ctx.measureText(testLine);
        if (metrics.width > scaledMaxWidth && currentLine.length > 0) {
          drawLineWithOutline(currentLine, scaledLeft, currentY);
          currentLine = char;
          currentY += lineHeight;
        } else {
          currentLine = testLine;
        }
      }
      if (currentLine) {
        drawLineWithOutline(currentLine, scaledLeft, currentY);
        currentY += lineHeight;
      }
    });

    const a = document.createElement("a");
    a.download = cardEl.dataset.filename || "illust.png";
    a.href = c.toDataURL("image/png");
    a.click();
  }

  DATA.forEach(makeCard);

  document.getElementById("card-count").textContent = "全 " + DATA.length + " 枚";

  // 一括書き出しの共通処理（exportable 配列を順に書き出し）
  const btnExportAll = document.getElementById("btn-export-all");
  const btnExportSelected = document.getElementById("btn-export-selected");
  const exportAllStatus = document.getElementById("export-all-status");
  function runBulkExport(exportable) {
    if (exportable.length === 0) {
      exportAllStatus.textContent = "書き出せる画像がありません。画像の読み込みが完了しているカードを選択してください。";
      return;
    }
    btnExportAll.disabled = true;
    btnExportSelected.disabled = true;
    exportAllStatus.textContent = "書き出し中... 0 / " + exportable.length + " 枚";
    let index = 0;
    function doNext() {
      if (index >= exportable.length) {
        exportAllStatus.textContent = exportable.length + " 枚を書き出しました。";
        btnExportAll.disabled = false;
        btnExportSelected.disabled = false;
        return;
      }
      exportCard(exportable[index]);
      index += 1;
      exportAllStatus.textContent = "書き出し中... " + index + " / " + exportable.length + " 枚";
      setTimeout(doNext, 150);
    }
    doNext();
  }
  btnExportAll.addEventListener("click", function() {
    const cards = Array.from(cardsEl.querySelectorAll(".card"));
    const exportable = cards.filter(function(card) {
      const img = card.querySelector("img");
      return img && img.complete && img.naturalWidth > 0;
    });
    if (exportable.length === 0) {
      exportAllStatus.textContent = "書き出せる画像がありません。画像の読み込みが完了してから再度お試しください。";
      return;
    }
    runBulkExport(exportable);
  });
  btnExportSelected.addEventListener("click", function() {
    const cards = Array.from(cardsEl.querySelectorAll(".card"));
    const selected = cards.filter(function(card) {
      const cb = card.querySelector(".card-select");
      return cb && cb.checked;
    });
    const exportable = selected.filter(function(card) {
      const img = card.querySelector("img");
      return img && img.complete && img.naturalWidth > 0;
    });
    if (selected.length === 0) {
      exportAllStatus.textContent = "OK が付いたカードがありません。書き出したいカードのチェックを入れてください。";
      return;
    }
    runBulkExport(exportable);
  });
})();
  </script>
</body>
</html>
